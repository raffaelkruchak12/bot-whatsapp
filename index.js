const { makeWASocket, useMultiFileAuthState, fetchLatestBaileysVersion, DisconnectReason } = require('@whiskeysockets/baileys');
const { Boom } = require('@hapi/boom');
const qrcode = require('qrcode');
const fs = require('fs');

async function startBot() {
  const { state, saveCreds } = await useMultiFileAuthState('./auth_info');
  const { version } = await fetchLatestBaileysVersion();

  const sock = makeWASocket({
    version,
    auth: state,
  });

  sock.ev.on('creds.update', saveCreds);

  const mensagensProcessadas = new Set();

  const respostas = {
    "bom dia": nome => `Bom dia, ${nome}! ‚òÄÔ∏è Eu sou o Rafael, assistente virtual. Como posso ajudar voc√™?`,
    "boa tarde": nome => `Boa tarde, ${nome}! üëã Sou o Rafael, assistente virtual. Qual sua d√∫vida?`,
    "boa noite": nome => `Boa noite, ${nome}! üåô Precisa de ajuda com nosso curso ou informa√ß√µes?`,
    "oi": nome => `Ol√°, ${nome}! üëã Eu sou o Rafael, assistente virtual. Me diz, como posso te ajudar?`,
    "oiie": nome => `Oiie, ${nome}! üòä Sou o Rafael, assistente virtual. Qual sua d√∫vida?`,
    "ola": nome => `Ol√°, ${nome}! üëã Sou o Rafael, assistente virtual. Estou aqui pra ajudar.`,
    "ol√°": nome => `Ol√°, ${nome}! üëã Me chamo Rafael, assistente virtual. Estou aqui pra ajudar.`,
    "boa": nome => `Tudo bem, ${nome}! üòÑ Como posso ajudar voc√™ hoje?`,
    "duvida": nome => `‚ùì Pode me perguntar qualquer d√∫vida que eu te ajudo rapidinho, ${nome}! Qual √© a sua?`,
    "estou com d√∫vida": nome => `‚ùì Pode me perguntar qualquer d√∫vida que eu te ajudo rapidinho, ${nome}! Qual √© a sua?`,
 "quanto": "üí∏ Custa s√≥ R$35 e voc√™ garante acesso vital√≠cio! üëâ Comece agora: https://pay.kiwify.com.br/oqjFfGk",
  "valor": "üöÄ Por apenas R$35 voc√™ domina a cria√ß√£o de v√≠deos realista com IA . Come√ße agora mesmo: https://pay.kiwify.com.br/oqjFfGk",
  "pre√ßo": "‚úÖ √öltimas vagas por R$35! Aprenda a usar IA para criar v√≠deos virais e monetizar nas redes sociais. Acesse agora: https://pay.kiwify.com.br/oqjFfGk",
  "pagamento": "‚úÖ Aceitamos Pix, Cart√£o ou Boleto. S√≥ R$35 pra transformar suas ideias em v√≠deos com IA! Link direto: https://pay.kiwify.com.br/oqjFfGk",
  "link": "üì≤ Pronto pra come√ßar? Aqui est√° seu link de acesso: https://pay.kiwify.com.br/oqjFfGk",
  "como fa√ßo para come√ßar": "üéØ Come√ßar √© simples! Acesse agora por apenas R$35 e libere seu acesso vital√≠cio: https://pay.kiwify.com.br/oqjFfGk",
  "sim": "‚úÖ √ìtima escolha! Garanta sua vaga agora mesmo: https://pay.kiwify.com.br/oqjFfGk",  
  "monetiza√ß√£o": "üí∞ Quer ganhar dinheiro com v√≠deos? Nosso curso te ensina as melhores estrat√©gias para monetizar conte√∫do com IA",
   "monetizar": "üí∞ Quer ganhar dinheiro com v√≠deos? Nosso curso te ensina as melhores estrat√©gias para monetizar conte√∫do com IA.",
  "Ola,gostaria de tirar uma d√∫vida ": "Ol√°, aqui √© o Rafael! Estou aqui para ajudar! Qual √© a sua d√∫vida? ü§î",
  "curso": "üìö O curso √© 100% online e pr√°tico! Voc√™ aprende passo a passo como criar v√≠deos realistas com IA usando s√≥ o celular. Mesmo sem experi√™ncia, voc√™ vai aprender a:\n\n1Ô∏è‚É£ Usar ferramentas de IA gratuitas com truques simples\n2Ô∏è‚É£ Criar prompts virais com ChatGPT (v√≠deo e imagem)\n3Ô∏è‚É£ Gerar v√≠deos autom√°ticos com rosto, voz e movimento\n4Ô∏è‚É£ Editar v√≠deos magn√©ticos pra redes sociais\n5Ô∏è‚É£ Monetizar e ganhar em d√≥lar com conte√∫do IA üí∏\n\nüéì Acesso vital√≠cio + suporte direto comigo!\n\n‚è≥ √öltimas vagas com valor promocional!: https://pay.kiwify.com.br/oqjFfGk",
  "intelig√™ncia artificial": "üß† Domine a cria√ß√£o de v√≠deos virais com Intelig√™ncia Artificial!\n\nAprenda passo a passo, mesmo sendo iniciante:\n‚úÖ Use ferramentas gratuitas e simples\nüí¨ Crie prompts incr√≠veis com ChatGPT (v√≠deos e imagens)\nüé¨ Gere v√≠deos autom√°ticos com rosto, voz e movimento\nüéØ Edite conte√∫dos magn√©ticos prontos pra viralizar\nüí∏ Aprenda estrat√©gias reais para ganhar dinheiro online (inclusive em d√≥lar!)\n\nAcesso vital√≠cio + suporte direto comigo!\nüëâ https://pay.kiwify.com.br/oqjFfGk",
  "ia": "üß† Domine a cria√ß√£o de v√≠deos virais com Intelig√™ncia Artificial!\n\nAprenda passo a passo, mesmo sendo iniciante:\n‚úÖ Use ferramentas gratuitas e simples\nüí¨ Crie prompts incr√≠veis com ChatGPT (v√≠deos e imagens)\nüé¨ Gere v√≠deos autom√°ticos com rosto, voz e movimento\nüéØ Edite conte√∫dos magn√©ticos prontos pra viralizar\nüí∏ Aprenda estrat√©gias reais para ganhar dinheiro online (inclusive em d√≥lar!)\n\nAcesso vital√≠cio + suporte direto comigo!\nüëâ https://pay.kiwify.com.br/oqjFfGk",
 "garanti": "üîí Compra 100% segura! Voc√™ tem 7 dias de garantia. Se n√£o ficar satisfeito, devolvemos seu dinheiro integralmente, sem burocracia e com total facilidade.",
  "aula gratuita": "üéÅ Quer ver como funciona antes? Assista a aula gratuita aqui: https://minitutorialveo.netlify.app/",
  "gratis": "üé• Veja a amostra gr√°tis e entenda como voc√™ pode criar v√≠deos com IA: https://minitutorialveo.netlify.app/",
  "como funciona": "üìö Voc√™ aprende passo a passo, com tutoriais pr√°ticos, como criar v√≠deos autom√°ticos com IA e ganhar em d√≥lar nas redes sociais. Aula gr√°tis: https://minitutorialveo.netlify.app/",
  "aprende": "üìö Voc√™ aprende passo a passo, com tutoriais pr√°ticos, como criar v√≠deos autom√°ticos com IA e ganhar em d√≥lar nas redes sociais. Aula gr√°tis: https://minitutorialveo.netlify.app/",
  "celular": "üì± Sim! Todo o curso √© adaptado para celular. S√≥ precisa de internet pra acessar quando quiser!",
  "suporte": "üí¨ Suporte direto comigo! Voc√™ pode tirar d√∫vidas e contar com orienta√ß√£o personalizada.",
  "iniciantes": "üöÄ Sim! Mesmo que voc√™ nunca tenha usado IA, o curso √© feito pra voc√™ aprender do zero.",
  "b√¥nus": "üéÅ Al√©m das aulas, voc√™ ganha acesso a lives, templates prontos, grupo exclusivo e muito mais!",
  "grupo": "üë• Sim! Temos uma comunidade ativa onde voc√™ pode trocar ideias e fazer networking comigo e outros alunos.",
  "editar v√≠deos": "‚ùå N√£o precisa! O curso √© pra quem quer criar v√≠deos autom√°ticos sem complica√ß√£o.",
  "online": "üåê 100% online! Voc√™ faz no seu tempo, de onde quiser.",
  "tempo": "üìÖ Voc√™ pode concluir em at√© 4 semanas, mas tem acesso vital√≠cio pra ver quando quiser!",
  "parcelar": "üí≥ Claro! Aceitamos parcelamento no cart√£o de cr√©dito em at√© 12x.",
  "conte√∫do": "üîÑ Atualizamos o curso com as √∫ltimas tend√™ncias de IA e ferramentas autom√°ticas.",
  "diferencial": "üåü √â direto ao ponto, pr√°tico, com suporte real e t√©cnicas testadas que funcionam!",
  "ganhar": "üí∞ Com certeza! A monetiza√ß√£o √© um dos pilares do curso. Voc√™ vai saber como ganhar em d√≥lar!",
  "instrutor": "üë®‚Äçüè´ O curso √© ensinado por mim, Rafael, e voc√™ ter√° contato direto comigo no grupo.",
  "viralizar v√≠deos": "üìà Sim! Estrat√©gias pra viralizar e ganhar seguidores + dinheiro est√£o inclu√≠das.",
  "como funciona": "üß† Nosso curso √© 100% online, pr√°tico e f√°cil para voc√™ aprender a criar v√≠deos virais usando IA. Confira: https://pay.kiwify.com.br/oqjFfGk",
  "mais informa√ß√µes": "üìö Veja todos os detalhes e informa√ß√µes aqui: https://treinamentogoogleveoo.netlify.app/",
  "baixar": "üì• Ol√°! Me chamo Rafael ‚Äî pe√ßo que salve meu contato para receber atualiza√ß√µes exclusivas üòä Me d√° um *OK* quando terminar que eu te mando o link para baixar mais materiais, blz? üòâ",
  "ok": "‚úÖ Show! Aqui est√° o link para baixar os *Prompts Virais Google VEO3*:\nüëâ https://drive.google.com/drive/folders/1A_llC1jO8CfrFVKufXjbayz7_iSJgjr9?usp=sharing",
"OK": "‚úÖ Show! Aqui est√° o link para baixar os *Prompts Virais Google VEO3*:\nüëâ https://drive.google.com/drive/folders/1A_llC1jO8CfrFVKufXjbayz7_iSJgjr9?usp=sharing",
"beleza": "‚úÖ Perfeito! Aqui est√° o link dos Prompts Virais Google VEO3:\nüëâ https://drive.google.com/drive/folders/1A_llC1jO8CfrFVKufXjbayz7_iSJgjr9?usp=sharing",
"gr√°tis": "üéÅ Quer ver como funciona antes? Assista a aula gratuita aqui: https://minitutorialveo.netlify.app/",
"gratis": "üéÅ Quer ver como funciona antes? Assista a aula gratuita aqui: https://minitutorialveo.netlify.app/",
 "ajuda": "Ol√°! Aqui √© o Rafael, seu assistente virtual. Estou aqui para te ajudar! üòä\nDiga qual √© a sua d√∫vida: sobre o curso, pagamento, link ou qualquer outra coisa.\n\nSe preferir, pode acessar mais informa√ß√µes completas aqui:\nhttps://treinamentogoogleveoo.netlify.app/"
  };

  sock.ev.on('connection.update', async ({ connection, qr, lastDisconnect }) => {
    if (qr) {
      await qrcode.toFile('qrcode.png', qr);
      console.log('üì≤ QR Code gerado e salvo em "qrcode.png". Escaneie com o WhatsApp.');
    }

    if (connection === 'close') {
      const reason = new Boom(lastDisconnect?.error)?.output.statusCode;
      console.log('‚ùå Conex√£o encerrada. Motivo:', reason);

      if (reason === DisconnectReason.loggedOut || reason === 401) {
        console.log('‚ö†Ô∏è Sess√£o inv√°lida. Apague a pasta auth_info e execute o bot novamente.');
        process.exit(1);
      } else {
        console.log('üîÅ Tentando reconectar...');
        startBot();
      }
    }

    if (connection === 'open') {
      console.log('‚úÖ Bot conectado com sucesso!');
    }
  });

  async function enviarAudio(path, sender) {
    try {
      if (!fs.existsSync(path)) {
        await sock.sendMessage(sender, { text: '‚ö†Ô∏è √Åudio n√£o encontrado no servidor.' });
        return;
      }
      await sock.sendPresenceUpdate('recording', sender);
      await new Promise(r => setTimeout(r, 1500));
      await sock.sendMessage(sender, {
        audio: fs.readFileSync(path),
        mimetype: 'audio/mpeg',
        ptt: true
      });
    } catch (err) {
      console.error('Erro ao enviar √°udio:', err);
      await sock.sendMessage(sender, { text: '‚ùå Erro ao enviar o √°udio. Tente novamente.' });
    }
  }

  sock.ev.on('messages.upsert', async ({ messages }) => {
    const msg = messages[0];
    if (!msg.message || msg.key.fromMe || mensagensProcessadas.has(msg.key.id)) return;
    mensagensProcessadas.add(msg.key.id);

    const sender = msg.key.remoteJid;
    const textoOriginal = (msg.message.conversation || msg.message.extendedTextMessage?.text || '').trim();
    const texto = textoOriginal.toLowerCase();
    const nomeLead = msg.pushName || '';

    if (texto === "1") return await enviarAudio('./info.mp3', sender);
    if (texto === "2") return await enviarAudio('./preco.mp3', sender);

    const chaveEncontrada = Object.keys(respostas).find(chave => texto === chave || texto.includes(chave));

    async function sendTypingThenMessage(text) {
      await sock.sendPresenceUpdate('composing', sender);
      await new Promise(r => setTimeout(r, 1500));
      await sock.sendPresenceUpdate('paused', sender);
      await sock.sendMessage(sender, { text });
    }

    if (chaveEncontrada) {
      const resposta = respostas[chaveEncontrada];
      const mensagem = typeof resposta === 'function' ? resposta(nomeLead) : resposta;
      await sendTypingThenMessage(mensagem);
    } else {
      await sendTypingThenMessage(`${nomeLead}, n√£o entendi muito bem... Mas t√¥ aqui pra te ajudar! Escolha uma op√ß√£o abaixo:\n\n` +
        "1 - üìò Informa√ß√µes sobre o curso\n" +
        "2 - üí≥ Pre√ßo e formas de pagamento\n" +
        "3 - üîó Link direto para se inscrever\n" +
        "4 - ‚ùì Tirar d√∫vidas ou falar comigo"
      );
    }
  });
}

startBot();

// Servidor web simples para visualizar e baixar o QR Code (necess√°rio no Render)
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

// Serve arquivos est√°ticos da pasta atual (inclui qrcode.png)
app.use(express.static(__dirname));

app.get('/', (req, res) => {
  res.send(`
    <h2>ü§ñ Bot WhatsApp Ativo!</h2>
    <p>Escaneie o QR abaixo com seu WhatsApp:</p>
    <img src="/qrcode.png" alt="QR Code" width="300"/>
    <p><a href="/qrcode.png" download>üì• Baixar QR Code</a></p>
  `);
});

app.listen(PORT, () => {
  console.log(`üåê Servidor web rodando: http://localhost:${PORT}`);
});

